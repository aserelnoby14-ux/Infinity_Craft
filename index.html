<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Infinity Craft - Ù…ÙˆØ¯Ø§Øª</title>
<style>
  :root{--red:#d62828;--green:#4caf50;--muted:#666}
  body{font-family:"Cairo",sans-serif;background:#fff;margin:0;color:#222;direction:rtl}
  header{background:var(--red);color:#fff;padding:14px 12px;text-align:center;font-weight:800}
  .topbar{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap;padding:10px;max-width:980px;margin:0 auto}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:var(--green);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;color:var(--red);border:2px solid var(--red)}
  .search{padding:8px;border-radius:8px;border:1px solid #ddd;width:240px}
  .container{max-width:980px;margin:14px auto;padding:12px}
  .card{background:#f7fff7;border-radius:12px;padding:14px;box-shadow:0 2px 6px rgba(0,0,0,.06)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:12px}
  .mod{background:#fff;border:2px solid #e6ffe6;border-radius:12px;padding:12px;display:flex;flex-direction:column}
  .thumb{height:160px;border-radius:8px;overflow:hidden;background:#eee;display:flex;align-items:center;justify-content:center}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .title{font-weight:800;margin:8px 0}
  .desc{color:var(--muted);font-size:14px;min-height:40px}
  .meta{display:flex;justify-content:space-between;align-items:center;margin-top:10px;gap:8px}
  .download{background:var(--red);color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none}
  .delete{background:#c62828;color:#fff;padding:6px 10px;border-radius:8px;border:none;cursor:pointer}
  .form{margin-top:12px;background:#f2f2f2;padding:12px;border-radius:10px}
  input,textarea,select{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ddd;box-sizing:border-box}
  footer{margin-top:20px;padding:18px;text-align:center;color:#444}
  .small{font-size:13px;color:var(--muted)}
  .hidden{display:none}
  @media(max-width:600px){.search{width:140px}}
</style>
</head>
<body>
<header>Infinity Craft - Ù…ÙˆØ¯Ø§Øª Ù…Ø§ÙŠÙ†ÙƒØ±Ø§ÙØª</header>

<div class="topbar">
  <div class="controls">
    <div id="greeting" class="small">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø²Ø§Ø¦Ø±</div>
  </div>

  <div class="controls">
    <input id="searchInput" class="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯..." />
    <button id="openPublishBtn" class="btn">ğŸ“¤ Ø§Ù†Ø´Ø± Ù…ÙˆØ¯Ùƒ</button>
    <button id="authBtn" class="btn ghost">ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„</button>
  </div>
</div>

<div class="container">

  <!-- Publish form -->
  <div id="publishCard" class="card hidden">
    <h3 style="margin:0 0 8px 0;text-align:center">Ù†Ø´Ø± Ù…ÙˆØ¯ Ø¬Ø¯ÙŠØ¯</h3>
    <div class="form">
      <input id="ownerLabel" placeholder="Ø§Ø³Ù…Ùƒ (Ø³ÙŠØ¸Ù‡Ø± ÙƒÙ…Ø§Ù„Ùƒ â€” Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
      <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯ *">
      <textarea id="description" rows="3" placeholder="ÙˆØµÙ Ø§Ù„Ù…ÙˆØ¯ *"></textarea>
      <input id="imageUrl" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø± *">
      <input id="downloadUrl" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„ *">
      <div style="display:flex;gap:8px;align-items:center">
        <button id="publishBtn" class="btn">Ù†Ø´Ø± Ø§Ù„Ù…ÙˆØ¯</button>
        <button id="closePublishBtn" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div id="publishMsg" class="small"></div>
    </div>
  </div>

  <!-- Auth panel -->
  <div id="authCard" class="card hidden" style="margin-top:12px">
    <h3 style="margin:0 0 8px 0;text-align:center">ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„</h3>
    <div class="form">
      <input id="email" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
      <input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
      <input id="displayName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø°ÙŠ Ø³ÙŠØ¸Ù‡Ø± (Ù„Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙ‚Ø·)">
      <div style="display:flex;gap:8px;align-items:center">
        <button id="signUpBtn" class="btn">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        <button id="signInBtn" class="btn ghost">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <button id="signOutBtn" class="btn hidden">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </div>
      <div id="authMsg" class="small"></div>
    </div>
  </div>

  <!-- Mods grid -->
  <div id="modsGrid" class="grid"></div>
  <div id="emptyMsg" class="small" style="text-align:center;margin-top:12px;display:none">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¯Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</div>

  <footer>
    <div>Ø§Ù„Ù…Ø·ÙˆØ±: <strong>Asernoby23</strong> &nbsp; Ø§Ù„Ù…Ø§Ù„Ùƒ: <strong>kraivx09</strong></div>
    <div style="margin-top:8px"><a href="https://t.me/+qq_iB3QRLpJjMGFk" target="_blank">Ù‚Ù†Ø§Ø© Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…</a></div>
  </footer>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAtn8wwDmlWe95RA13kAQiY0XDkhnuKoQ0",
  authDomain: "infinity-craft-301e4.firebaseapp.com",
  databaseURL: "https://infinity-craft-301e4-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "infinity-craft-301e4",
  storageBucket: "infinity-craft-301e4.firebasestorage.app",
  messagingSenderId: "979672021905",
  appId: "1:979672021905:web:849ecc0ed6379edb2eb830",
  measurementId: "G-G188MXB3JY"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// UI refs
const greeting = document.getElementById('greeting');
const authBtn = document.getElementById('authBtn');
const authCard = document.getElementById('authCard');
const signUpBtn = document.getElementById('signUpBtn');
const signInBtn = document.getElementById('signInBtn');
const signOutBtn = document.getElementById('signOutBtn');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const displayNameInput = document.getElementById('displayName');
const authMsg = document.getElementById('authMsg');

const openPublishBtn = document.getElementById('openPublishBtn');
const publishCard = document.getElementById('publishCard');
const closePublishBtn = document.getElementById('closePublishBtn');
const publishBtn = document.getElementById('publishBtn');
const publishMsg = document.getElementById('publishMsg');
const ownerLabel = document.getElementById('ownerLabel');
const nameInput = document.getElementById('name');
const descInput = document.getElementById('description');
const imageInput = document.getElementById('imageUrl');
const downloadInput = document.getElementById('downloadUrl');

const modsGrid = document.getElementById('modsGrid');
const searchInput = document.getElementById('searchInput');
const emptyMsg = document.getElementById('emptyMsg');

// auth UI
authBtn.addEventListener('click', ()=> authCard.classList.toggle('hidden'));

signUpBtn.addEventListener('click', async ()=>{
  authMsg.textContent='';
  const email = emailInput.value.trim();
  const pass = passwordInput.value;
  const name = displayNameInput.value.trim() || email.split('@')[0];
  if(!email || !pass){ authMsg.textContent='Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'; return; }
  try{
    const cred = await createUserWithEmailAndPassword(auth,email,pass);
    await updateProfile(cred.user,{displayName:name});
    authMsg.style.color='green'; authMsg.textContent='ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
  }catch(e){ authMsg.style.color='red'; authMsg.textContent=e.message; }
});

signInBtn.addEventListener('click', async ()=>{
  authMsg.textContent='';
  const email = emailInput.value.trim();
  const pass = passwordInput.value;
  if(!email||!pass){ authMsg.textContent='Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'; return; }
  try{
    await signInWithEmailAndPassword(auth,email,pass);
    authMsg.style.color='green'; authMsg.textContent='ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
  }catch(e){ authMsg.style.color='red'; authMsg.textContent=e.message; }
});

signOutBtn.addEventListener('click', async ()=> await signOut(auth));

openPublishBtn.addEventListener('click', ()=>{
  if(!auth.currentUser){ alert('Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¹Ø´Ø§Ù† ØªÙ†Ø´Ø±'); return; }
  publishCard.classList.toggle('hidden');
  publishMsg.textContent='';
  ownerLabel.value = auth.currentUser.displayName || auth.currentUser.email.split('@')[0];
});
closePublishBtn.addEventListener('click', ()=> publishCard.classList.add('hidden'));

publishBtn.addEventListener('click', async ()=>{
  publishMsg.textContent='';
  const user = auth.currentUser;
  if(!user){ publishMsg.style.color='red'; publishMsg.textContent='Ù„Ø§Ø²Ù… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„'; return; }
  const ownerName = ownerLabel.value.trim() || user.displayName || user.email.split('@')[0];
  const name = nameInput.value.trim();
  const desc = descInput.value.trim();
  const imageUrl = imageInput.value.trim();
  const downloadUrl = downloadInput.value.trim();
  if(!name||!desc||!downloadUrl){ publishMsg.style.color='red'; publishMsg.textContent='Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©'; return; }
  publishMsg.style.color='black'; publishMsg.textContent='Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø±...';
  try{
    const newRef = push(ref(db,'mods'));
    await set(newRef,{
      name,
      description:desc,
      imageUrl,
      downloadLink:downloadUrl,
      ownerUid:user.uid,
      ownerName,
      createdAt:Date.now()
    });
    publishMsg.style.color='green'; publishMsg.textContent='ØªÙ… Ø§Ù„Ù†Ø´Ø± âœ…';
    nameInput.value=''; descInput.value=''; imageInput.value=''; downloadInput.value='';
    publishCard.classList.add('hidden');
  }catch(e){ publishMsg.style.color='red'; publishMsg.textContent='Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø´Ø±'; console.error(e);}
});

// escape
function escapeHtml(s){ if(!s) return ''; return s.toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

// render mods
function renderMods(list){
  modsGrid.innerHTML='';
  if(!list||list.length===0){ emptyMsg.style.display='block'; return; } else emptyMsg.style.display='none';
  const viewerUid = auth.currentUser?auth.currentUser.uid:null;
  const term=(searchInput.value||'').trim().toLowerCase();
  list.forEach(item=>{
    if(term){
      const ok=(item.name||'').toLowerCase().includes(term)||(item.description||'').toLowerCase().includes(term)||(item.ownerName||'').toLowerCase().includes(term);
      if(!ok) return;
    }
    const col=document.createElement('div'); col.className='mod';
    col.innerHTML=`
      <div class="thumb">${ item.imageUrl ? `<img src="${escapeHtml(item.imageUrl)}" alt="${escapeHtml(item.name)}" onerror="this.style.display='none'">` : '<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</div>' }</div>
      <div class="title">${escapeHtml(item.name)}</div>
      <div class="desc">${escapeHtml(item.description)}</div>
      <div class="meta">
        <a class="download" href="${escapeHtml(item.downloadLink)}" target="_blank">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„</a>
        <div class="small">Ø¨ÙˆØ§Ø³Ø·Ø©: ${escapeHtml(item.ownerName||'Ù…Ø¬Ù‡ÙˆÙ„')}</div>
      </div>
    `;
    if(viewerUid && item.ownerUid && viewerUid===item.ownerUid){
      const del=document.createElement('button');
      del.className='delete'; del.textContent='ğŸ—‘ï¸ Ø­Ø°Ù'; del.style.marginTop='8px';
      del.onclick=async()=>{
        if(!confirm('Ù…ØªØ£ÙƒØ¯ ØªØ­Ø°Ù Ø§Ù„Ù…ÙˆØ¯ØŸ')) return;
        try{ await remove(ref(db,'mods/'+item._id)); alert('ØªÙ… Ø§Ù„Ø­Ø°Ù âœ…'); }
        catch(e){ alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù'); console.error(e);}
      };
      col.appendChild(del);
    }
    modsGrid.appendChild(col);
  });
}

// realtime listener
onValue(ref(db,'mods'), snapshot=>{
  const val=snapshot.val();
  const arr=[];
  if(val) Object.entries(val).forEach(([k,v])=>arr.push(Object.assign({_id:k},v)));
  arr.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  renderMods(arr);
});

// search
searchInput.addEventListener('input',()=> onValue(ref(db,'mods'), snapshot=>{
  const val=snapshot.val();
  const arr=[];
  if(val) Object.entries(val).forEach(([k,v])=>arr.push(Object.assign({_id:k},v)));
  arr.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  renderMods(arr);
},{onlyOnce:true}));

// auth state
onAuthStateChanged(auth,user=>{
  if(user){
    greeting.textContent=`Ù…Ø±Ø­Ø¨Ù‹Ø§ ÙŠØ§ ${user.displayName||user.email.split('@')[0]}`;
    authBtn.classList.add('hidden');
    signOutBtn.classList.remove('hidden');
  }else{
    greeting.textContent='Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø²Ø§Ø¦Ø±';
    authBtn.classList.remove('hidden');
    signOutBtn.classList.add('hidden');
  }
  // ÙÙˆØ±Ù‹Ø§ Ø­Ø¯Ø« Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¯Ø§Øª Ø¨Ø¹Ø¯ Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  onValue(ref(db,'mods'),snapshot=>{
    const val=snapshot.val(); const arr=[];
    if(val) Object.entries(val).forEach(([k,v])=>arr.push(Object.assign({_id:k},v)));
    arr.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    renderMods(arr);
  },{onlyOnce:true});
});
</script>
</body>
</html>
