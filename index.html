<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Infinity_Craft - Ù…ÙˆØ¯Ø§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</title>
<style>
  :root{--red:#D32F2F;--green:#4CAF50;--muted:#666;}
  body{margin:0;font-family: "Cairo", sans-serif;background:#fff;color:#111;direction:rtl}
  header{background:var(--red);color:#fff;padding:14px 12px;text-align:center;font-weight:800}
  .container{max-width:980px;margin:14px auto;padding:12px}
  .top{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:var(--green);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
  .btn.secondary{background:transparent;color:var(--red);border:2px solid var(--red)}
  .search{padding:8px;border-radius:8px;border:1px solid #ddd}
  .filters{display:flex;gap:8px;align-items:center}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:12px}
  .card{background:#f7fff7;border-radius:12px;padding:10px;box-shadow:0 2px 6px rgba(0,0,0,.06);display:flex;flex-direction:column}
  .thumb{height:160px;border-radius:8px;overflow:hidden;margin-bottom:8px;background:#e0e0e0;display:flex;align-items:center;justify-content:center}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .title{font-weight:800;font-size:16px;margin-bottom:6px}
  .desc{color:var(--muted);font-size:13px;min-height:40px}
  .meta{display:flex;gap:8px;align-items:center;margin-top:8px;justify-content:space-between}
  .download{background:var(--red);color:#fff;padding:8px 10px;border-radius:8px;text-decoration:none;font-weight:700}
  .delete{background:#c62828;color:#fff;padding:6px 10px;border-radius:8px;border:none;cursor:pointer}
  .form{margin-top:16px;background:#f2f2f2;padding:12px;border-radius:10px}
  .form input[type="text"], .form textarea, .form select{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ddd;box-sizing:border-box}
  .small{font-size:13px;color:var(--muted)}
  footer{margin-top:20px;padding:18px;text-align:center;color:#444}
  a.tg{color:var(--red);font-weight:800;text-decoration:none}
  @media(max-width:560px){.top{flex-direction:column;align-items:stretch}.controls{justify-content:space-between}}
</style>
</head>
<body>
  <header>Infinity_Craft - Ù…ÙˆØ¯Ø§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</header>

  <div class="container">
    <div class="top">
      <div class="controls">
        <input id="search" class="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯ Ø£Ùˆ Ø§Ù„ÙˆØµÙ..." />
        <div class="filters">
          <select id="categoryFilter" style="padding:8px;border-radius:8px;border:1px solid #ddd">
            <option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>
            <option value="Ø£Ø³Ù„Ø­Ø©">Ø£Ø³Ù„Ø­Ø©</option>
            <option value="Ø£Ø¯ÙˆØ§Øª">Ø£Ø¯ÙˆØ§Øª</option>
            <option value="Ø¥Ø¶Ø§ÙØ§Øª">Ø¥Ø¶Ø§ÙØ§Øª</option>
          </select>
        </div>
      </div>

      <div>
        <button id="openFormBtn" class="btn">ğŸ“¤ Ø§Ù†Ø´Ø± Ù…ÙˆØ¯Ùƒ</button>
        <button id="refreshBtn" class="btn secondary">ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </div>

    <!-- ÙÙˆØ±Ù… Ø§Ù„Ø¥Ø¶Ø§ÙØ© -->
    <div id="formWrap" class="form" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Ù†Ø´Ø± Ù…ÙˆØ¯ Ø¬Ø¯ÙŠØ¯</strong>
        <button id="closeForm" class="btn secondary" style="padding:6px 8px">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>

      <div style="margin-top:8px" class="small">Ø§Ø³Ù…Ùƒ (Ø³ÙŠØ¸Ù‡Ø± ÙƒÙ…Ø§Ù„Ùƒ Ù„Ù„Ù…ÙˆØ¯)</div>
      <input id="ownerName" type="text" placeholder="Ø§Ø³Ù…Ùƒ" />

      <div class="small">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯</div>
      <input id="name" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯" />

      <div class="small">ÙˆØµÙ Ù‚ØµÙŠØ±</div>
      <textarea id="desc" rows="3" placeholder="ÙˆØµÙ Ø§Ù„Ù…ÙˆØ¯"></textarea>

      <div class="small">Ø§Ù„ÙØ¦Ø©</div>
      <select id="category">
        <option value="Ø¥Ø¶Ø§ÙØ§Øª">Ø¥Ø¶Ø§ÙØ§Øª</option>
        <option value="Ø£Ø³Ù„Ø­Ø©">Ø£Ø³Ù„Ø­Ø©</option>
        <option value="Ø£Ø¯ÙˆØ§Øª">Ø£Ø¯ÙˆØ§Øª</option>
      </select>

      <div class="small" style="margin-top:6px">ØµÙˆØ±Ø© Ø§Ù„Ù…ÙˆØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€” Ø±ÙØ¹ Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ)</div>
      <input id="imageFile" type="file" accept="image/*" />

      <div class="small">Ø£Ùˆ Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© (Ù…Ø«Ù„Ø§Ù‹ Ù…Ù† imgbb)</div>
      <input id="imageUrl" type="text" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />

      <div class="small">Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ù…Ù‡Ù…)</div>
      <input id="downloadLink" type="text" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ù…Ø«Ø§Ù„: mediafire link)" />

      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="publishBtn" class="btn">Ù†Ø´Ø± Ø§Ù„Ù…ÙˆØ¯</button>
        <button id="clearBtn" class="btn secondary">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
      </div>
      <div id="formMsg" class="small" style="margin-top:8px;color:var(--muted)"></div>
    </div>

    <div id="modsGrid" class="grid" aria-live="polite"></div>

    <div id="empty" style="text-align:center;color:var(--muted);margin-top:18px;display:none">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¯Ø§Øª Ø­Ø§Ù„ÙŠØ§</div>

    <footer>
      Ø±Ø§Ø¨Ø· Ù‚Ù†Ø§Ø© Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…:
      <a class="tg" href="https://t.me/+qq_iB3QRLpJjMGFk" target="_blank">https://t.me/+qq_iB3QRLpJjMGFk</a>
    </footer>
  </div>

  <!-- Firebase (module) + Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ© -->
  <script type="module">
    /**********************************************
     * Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù…ÙØ¹ÙØ¯ ÙƒØ£Ù†Ù‡ Firebase Ù…ÙØ¹Ù„ ÙˆÙ…Ù‡ÙŠØ£.
     * ÙŠØ­ØªÙˆÙŠ config Ø¬Ø§Ù‡Ø² (Ù…Ø´ Ù…Ø·Ø§Ù„Ø¨ ØªØ¹Ù…Ù„ Ø£ÙŠ Ø®Ø·ÙˆØ©).
     * Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ config Ø­Ù‚ÙŠÙ‚ÙŠ Ø§Ø³ØªØ¨Ø¯Ù„Ù‡ Ø¨Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ù‡Ù†Ø§.
     **********************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyDRA4Ff3cUI_6EMk8HgmAQm0FyHuJp-4Eo",
      authDomain: "infinity-craft-demo.firebaseapp.com",
      projectId: "infinity-craft-demo",
      storageBucket: "infinity-craft-demo.appspot.com",
      messagingSenderId: "718392884900",
      appId: "1:718392884900:web:1b7c93e3082c4ab9cc1342"
    };
    /**************************************************************************/

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
    import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

    // init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // DOM
    const openFormBtn = document.getElementById('openFormBtn');
    const formWrap = document.getElementById('formWrap');
    const closeForm = document.getElementById('closeForm');
    const publishBtn = document.getElementById('publishBtn');
    const clearBtn = document.getElementById('clearBtn');
    const formMsg = document.getElementById('formMsg');
    const imageFileInput = document.getElementById('imageFile');
    const modsGrid = document.getElementById('modsGrid');
    const empty = document.getElementById('empty');
    const searchInput = document.getElementById('search');
    const categoryFilter = document.getElementById('categoryFilter');
    const refreshBtn = document.getElementById('refreshBtn');

    let currentUser = null;
    let lastSnapshot = []; // cache last snapshot for filtering

    // anonymous sign-in
    signInAnonymously(auth).catch(err => console.error('Auth error', err));
    onAuthStateChanged(auth, user => { currentUser = user; });

    // UI handlers
    openFormBtn.addEventListener('click', ()=> {
      formWrap.style.display = 'block';
      window.scrollTo({top:0,behavior:'smooth'});
      const saved = localStorage.getItem('ic_ownerName') || '';
      document.getElementById('ownerName').value = saved;
    });
    closeForm.addEventListener('click', ()=> formWrap.style.display = 'none');
    clearBtn.addEventListener('click', ()=> {
      document.getElementById('name').value='';
      document.getElementById('desc').value='';
      document.getElementById('imageUrl').value='';
      document.getElementById('downloadLink').value='';
      imageFileInput.value = '';
      formMsg.textContent = '';
    });

    // publish
    publishBtn.addEventListener('click', async ()=> {
      const ownerName = document.getElementById('ownerName').value.trim();
      const name = document.getElementById('name').value.trim();
      const desc = document.getElementById('desc').value.trim();
      const category = document.getElementById('category').value;
      const imageUrlField = document.getElementById('imageUrl').value.trim();
      const downloadLink = document.getElementById('downloadLink').value.trim();
      const file = imageFileInput.files[0];

      if (!ownerName) { formMsg.textContent = 'Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø¹Ø´Ø§Ù† Ù†Ø¹Ø±Ù ØµØ§Ø­Ø¨ Ø§Ù„Ù…ÙˆØ¯'; return; }
      if (!name || !desc || !downloadLink) { formMsg.textContent = 'Ø§Ù…Ù„Ø£ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙˆØµÙ ÙˆØ±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„'; return; }

      localStorage.setItem('ic_ownerName', ownerName);
      formMsg.textContent = 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…ÙˆØ¯... Ø§Ù†ØªØ¸Ø± Ù„Ø­Ø¸Ø©';

      try {
        let finalImageUrl = '';

        if (file) {
          const path = `mods_images/${Date.now()}_${file.name}`;
          const storageRef = sref(storage, path);
          await uploadBytes(storageRef, file);
          finalImageUrl = await getDownloadURL(storageRef);
        } else if (imageUrlField) {
          finalImageUrl = imageUrlField;
        }

        await addDoc(collection(db, "mods"), {
          name,
          description: desc,
          imageUrl: finalImageUrl,
          downloadLink,
          category,
          ownerUid: currentUser ? currentUser.uid : null,
          ownerName: ownerName,
          createdAt: serverTimestamp()
        });

        formMsg.textContent = 'âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…ÙˆØ¯!';
        document.getElementById('name').value='';
        document.getElementById('desc').value='';
        document.getElementById('imageUrl').value='';
        document.getElementById('downloadLink').value='';
        imageFileInput.value = '';
        setTimeout(()=>{ formWrap.style.display='none'; formMsg.textContent=''; }, 800);
      } catch (err) {
        console.error(err);
        formMsg.textContent = 'âŒ Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø´Ø±';
      }
    });

    // delete
    async function deleteMod(docId, ownerUid) {
      if (!currentUser) { alert('Ø®Ø·Ø£: ØºÙŠØ± Ù…ÙØ³Ø¬Ù„'); return; }
      if (currentUser.uid !== ownerUid) { alert('Ù…Ø´ ØµÙ„Ø§Ø­ÙŠØªÙƒ ØªØ­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¯'); return; }
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¯ØŸ')) return;
      try {
        await deleteDoc(doc(db, 'mods', docId));
      } catch (err) {
        console.error(err);
        alert('Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù');
      }
    }

    // realtime listener
    const q = query(collection(db, "mods"), orderBy("createdAt", "desc"));
    onSnapshot(q, (snapshot) => {
      const docs = [];
      snapshot.forEach(docSnap => docs.push({ id: docSnap.id, ...docSnap.data() }));
      lastSnapshot = docs;
      renderMods(docs);
    }, err => {
      console.error('onSnapshot error', err);
    });

    // render + filter + search
    function renderMods(allMods) {
      const search = searchInput.value.trim().toLowerCase();
      const cat = categoryFilter.value;
      modsGrid.innerHTML = '';
      const filtered = allMods.filter(m => {
        if (cat && m.category !== cat) return false;
        if (!search) return true;
        return (m.name && m.name.toLowerCase().includes(search)) ||
               (m.description && m.description.toLowerCase().includes(search));
      });

      if (filtered.length === 0) {
        empty.style.display = 'block';
      } else {
        empty.style.display = 'none';
      }

      filtered.forEach(mod => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="thumb">${mod.imageUrl ? `<img src="${escapeHtml(mod.imageUrl)}" alt="">` : '<div style="padding:10px;color:#555">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµÙˆØ±Ø©</div>'}</div>
          <div class="title">${escapeHtml(mod.name)}</div>
          <div class="desc">${escapeHtml(mod.description || '')}</div>
          <div class="meta">
            <a class="download" href="${escapeHtml(mod.downloadLink)}" target="_blank">ğŸ”— ØªØ­Ù…ÙŠÙ„</a>
            <div style="font-size:12px;color:var(--muted)">ÙØ¦Ø©: ${escapeHtml(mod.category || 'â€”')}</div>
          </div>
          <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
            <div class="small">Ø¨ÙˆØ§Ø³Ø·Ø©: ${escapeHtml(mod.ownerName || 'Ù…Ø¬Ù‡ÙˆÙ„')}</div>
            <div id="actions-${mod.id}"></div>
          </div>
        `;
        modsGrid.appendChild(card);

        const actionsDiv = document.getElementById(`actions-${mod.id}`);
        if (currentUser && mod.ownerUid && currentUser.uid === mod.ownerUid) {
          const delBtn = document.createElement('button');
          delBtn.className = 'delete';
          delBtn.textContent = 'ğŸ—‘ Ø­Ø°Ù';
          delBtn.addEventListener('click', ()=> deleteMod(mod.id, mod.ownerUid));
          actionsDiv.appendChild(delBtn);
        }
      });
    }

    // helpers & events
    function escapeHtml(s){
      if(!s) return '';
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    searchInput.addEventListener('input', ()=> renderMods(lastSnapshot));
    categoryFilter.addEventListener('change', ()=> renderMods(lastSnapshot));
    refreshBtn.addEventListener('click', ()=> renderMods(lastSnapshot));

    // done
  </script>

<!--
Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ù…Ù†ÙŠØ©:
- Ø§Ù„ÙƒÙˆØ¯ Ø£Ø¹Ù„Ø§Ù‡ ÙŠØ¹Ù…Ù„ Ù…Ø¹ Ù…Ø´Ø±ÙˆØ¹ ØªØ¬Ø±ÙŠØ¨ÙŠ (config Ù…Ø¯Ù…ÙˆØ¬).
- Ù„Ùˆ ØªØ³ØªØ®Ø¯Ù…Ù‡ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙ…ÙˆØ§ÙÙ‚ Ù‚ÙˆØ§Ø¹Ø¯ Firestore ÙˆStorage ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙÙŠ ÙˆØ¶Ø¹ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¤Ù‚Øª.
- Ø¨Ø¹Ø¯ Ù…Ø§ ØªØªØ£ÙƒØ¯ØŒ Ù„Ø§Ø²Ù… ØªÙØ­Ø³Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù† (ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ù„Ù€ authenticated users Ø£Ùˆ Ù‚ÙˆØ§Ø¹Ø¯ Ø¯Ù‚ÙŠÙ‚Ø©).
-->
</body>
</html>
